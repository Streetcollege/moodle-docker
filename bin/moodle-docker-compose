#!/usr/bin/env bash
set -e

# Nasty portable way to the directory of this script, following symlink,
# because readlink -f not on OSX. Thanks stack overflow..
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
basedir="$( cd -P "$( dirname "$SOURCE" )/../" && pwd )"
export ASSETDIR="${basedir}/assets"

if [ -f "${basedir}/.env" ];
then
  . "${basedir}/.env"
fi

if [ ! -d "$MOODLE_DOCKER_WWWROOT" ];
then
    echo 'Error: $MOODLE_DOCKER_WWWROOT is not set or not an existing directory'
    exit 1
fi

if [ ! -n "$MOODLE_DOCKER_DBPASS" ];
then
    echo 'Error: $MOODLE_DOCKER_DBPASS is not set'
    exit 1
fi

if [ ! -n "$MOODLE_DOCKER_WEB_HOST" ];
then
    echo 'Error: $MOODLE_DOCKER_WEB_HOST is not set'
    exit 1
fi

# PHP Version.
export MOODLE_DOCKER_PHP_VERSION=${MOODLE_DOCKER_PHP_VERSION:-7.1}

# Webserver port
export MOODLE_DOCKER_WEB_PORT=${MOODLE_DOCKER_WEB_PORT:-80}

dockercompose="docker-compose -f ${basedir}/base.yml"

# Load mailhog if no SMTP host set
if [ ! -n "$MOODLE_DOCKER_SMTP_HOST" ];
then
    dockercompose="${dockercompose} -f ${basedir}/service.mail.yml"
fi

if [ "$1" = "down" ]; then
  echo "This will destroy your containers! Continue? (type \"yes\")"
  read confirmation
  if [ "$confirmation" != "yes" ]; then
    echo "Operation aborted"
    exit 1
  fi
fi


$dockercompose $@
